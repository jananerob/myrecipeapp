<%= form_with(model: recipe, class: "max-w-3xl mx-auto bg-white p-8 border border-orange-100 rounded-2xl space-y-6") do |form| %>

  <% if recipe.errors.any? %>
    <%# Chybov√© hl√°≈°ky laden√© do jemnej oran≈æovo-ƒçervenej %>
    <div class="bg-orange-50 border-l-4 border-orange-500 p-4 mb-6 rounded-r-lg">
      <h2 class="text-orange-900 font-bold"><%= pluralize(recipe.errors.count, "error") %> prohibited this recipe from being saved:</h2>
      <ul class="list-disc ml-5 text-orange-800 text-sm">
        <% recipe.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%# Z√°kladn√© √∫daje %>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="md:col-span-3">
      <%= form.label :title, class: "block text-sm font-medium text-orange-900 mb-1" %>
      <%= form.text_field :title, class: "appearance-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-orange-400 focus:border-orange-400 focus:z-10 sm:text-sm" %>
    </div>

    <div class="md:col-span-3">
      <%= form.label :instructions, class: "block text-sm font-semibold text-orange-900 mb-1" %>
      <%= form.text_area :instructions, rows: 5, class: "appearance-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-orange-400 focus:border-orange-400 focus:z-10 sm:text-sm" %>
    </div>

    <%# ƒåasy v jednom riadku %>
    <div>
      <%= form.label :prep_time, "Prep Time (min)", class: "block text-sm font-semibold text-orange-900 mb-1" %>
      <%= form.number_field :prep_time, class: "appearance-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-orange-400 focus:border-orange-400 focus:z-10 sm:text-sm" %>
    </div>
    <div>
      <%= form.label :cook_time, "Cook Time (min)", class: "block text-sm font-semibold text-orange-900 mb-1" %>
      <%= form.number_field :cook_time, class: "appearance-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-orange-400 focus:border-orange-400 focus:z-10 sm:text-sm" %>
    </div>
    <div>
      <%= form.label :calories, "Calories (kcal)", class: "block text-sm font-semibold text-orange-900 mb-1" %>
      <%= form.text_field :calories, class: "appearance-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-orange-400 focus:border-orange-400 focus:z-10 sm:text-sm" %>
    </div>
  </div>

  <%# Ingrediencie %>
  <div class="pt-6 border-t border-orange-50">
    <h3 class="text-lg font-bold text-orange-900 mb-4 flex items-center">
      <span class="mr-2 text-orange-400">ü•ï</span> Ingredients
    </h3>

    <%# "Header" tabuƒæky s ingredienciami %>
    <div class="grid grid-cols-12 gap-4 px-2 mb-2 border-b border-orange-100 pb-1">
      <div class="col-span-6 text-xs font-bold text-orange-900 uppercase text-center">Ingredient</div>
      <div class="col-span-2 text-xs font-bold text-orange-900 uppercase text-center">Amount</div>
      <div class="col-span-2 text-xs font-bold text-orange-900 uppercase text-center">Unit</div>
      <div class="col-span-2"></div>
    </div>

    <div id="ingredients-fields" class="space-y-3">
      <% recipe.recipe_ingredients.each do |ri| %>
        <%= render 'recipe_ingredient_fields', recipe_ingredient: ri, all_ingredients: Ingredient.all %>
      <% end %>

      <% if recipe.new_record? && recipe.recipe_ingredients.empty? %>
        <%= render 'recipe_ingredient_fields', recipe_ingredient: recipe.recipe_ingredients.build, all_ingredients: Ingredient.all %>
      <% end %>
    </div>

    <button type="button" id="add-ingredient-button" 
        class="mt-4 flex items-center justify-center w-10 h-10 rounded-full border-0 text-sm font-semibold bg-orange-100 text-orange-700 hover:bg-orange-200 transition cursor-pointer focus:outline-none"
        title="Add ingredient">
      <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
      </svg>
    </button>
  </div>

  <%# Tagy a S√∫kromie %>
  <div class="pt-6 border-t border-orange-50 grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
      <%= form.label :tag_ids, 'Tags', class: "block text-sm font-semibold text-orange-900 mb-1" %>
      <%= form.select :tag_ids, Tag.all.map { |t| [t.name, t.id] }, { include_blank: 'Select tags' }, { multiple: true, class: "w-full rounded-lg border-orange-200 focus:border-orange-400 focus:ring focus:ring-orange-200 focus:ring-opacity-50 min-h-[100px]" } %>
    </div>

    <div class="flex items-center space-x-3 bg-orange-50 p-4 rounded-xl self-start border border-orange-100">
      <%= form.check_box :is_private, class: "h-5 w-5 text-orange-500 focus:ring-orange-400 border-orange-300 rounded" %>
      <%= form.label :is_private, "Private recipe (Only you will see this)", class: "text-sm font-medium text-orange-900" %>
    </div>
  </div>

  <%# Foto receptu %>
  <div class="pt-6 border-t border-orange-50">
    <%= form.label :image, "Recipe photo", class: "block text-orange-900 font-bold mb-2" %>

    <% if @recipe.image.attached? && @recipe.image.persisted? %>
      <div class="flex items-center space-x-4 mb-4 bg-orange-50 p-3 rounded-xl border border-orange-100">
        <%= image_tag @recipe.image, class: "w-20 h-20 object-cover rounded-lg border-2 border-white" %>
        <div class="flex items-center">
          <%= form.check_box :remove_image, class: "w-4 h-4 text-red-500 border-orange-300 rounded focus:ring-red-400" %>
          <%= form.label :remove_image, "Remove current photo", class: "ml-2 text-sm text-red-600 font-semibold" %>
        </div>
      </div>
    <% end %>

    <%= form.file_field :image, 
      class: "block w-fit text-sm text-gray-500 
              file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 
              file:text-sm file:font-semibold file:bg-orange-100 file:text-orange-700 
              hover:file:bg-orange-200 
              file:transition file:duration-200 transition cursor-pointer" %>
  </div>

  <%# Submit tlaƒçidlo %>
  <div class="pt-6 border-t border-orange-100 flex justify-end">
    <%= form.submit class: "bg-gradient-to-r from-orange-400 to-orange-500 hover:from-orange-500 hover:to-orange-600 text-white font-bold py-3 px-10 rounded-xl transform active:scale-95 transition-all duration-200 cursor-pointer" %>
  </div>

<% end %>

<template id="ingredient-template">
  <%= render 'recipe_ingredient_fields', recipe_ingredient: RecipeIngredient.new, all_ingredients: Ingredient.all %>
</template>

<!--  JavaScript pre prid√°vanie a odstra≈àovanie nov√Ωch z√°znamov ingredienci√≠
      prediskutova≈•, ƒçi nespravi≈• len cez fixn√Ω poƒçet mo≈æn√Ωch ingredienci√≠,
      alebo in√© rie≈°enie? Pri ka≈ædom kliknut√≠ na add_ingredient by sa ulo≈æil recept
      a pridal nov√Ω riadok pre nov√∫ ingredienciu, ale to sa mi v√¥bec nep√°ƒçi. -->

<script>
  document.addEventListener('turbo:load', () => {
    const container = document.getElementById('ingredients-fields');
    const addButton = document.getElementById('add-ingredient-button');
    const template = document.getElementById('ingredient-template');

    if (!addButton || !template) return; // Ukonƒç√≠, ak nie je na str√°nke s formul√°rom

    // Funkcia na pridanie riadku
    addButton.addEventListener('click', () => {
      // 1. Naklonuje obsah ≈°abl√≥ny
      const newFields = template.content.cloneNode(true);

      // 2. Vlo≈æ√≠ nov√© polia na koniec kontajnera
      container.appendChild(newFields);
    });

    // Funkcia na odstr√°nenie riadku (Delegovanie udalosti na kontajner)
    // Nov√©: Po kliknut√≠ na Remove oznaƒç√≠ riadok na zmazanie

    container.addEventListener('click', (e) => {
      if (e.target.classList.contains('remove-ingredient-button')) {

        // 1. N√°jdeme kontajner pre jeden riadok ingrediencie
        const ingredientFieldSet = e.target.closest('.ingredient-field-set');
        if (!ingredientFieldSet) return;

        // 2. N√°jdeme skryt√© pole pre zmazanie v r√°mci tohto riadku
        // TIP: pridaj si k tomuto poƒæu triedu, aby sa ƒæah≈°ie hƒæadalo (napr. class: 'destroy-field')
        const destroyField = ingredientFieldSet.querySelector('input[type="hidden"][name$="[_destroy]"]');

        // 3. Ak je to existuj√∫ci z√°znam, oznaƒç√≠me ho na zmazanie a skryjeme
        if (destroyField) {
          destroyField.value = '1'; // Nastav√≠ _destroy na 1
          ingredientFieldSet.style.display = 'none'; // Skryje vizu√°lne riadok

          // Bonus: Ak je to nov√Ω riadok, ktor√Ω e≈°te nebol ulo≈æen√Ω (nem√° ID), m√¥≈æeme ho odstr√°ni≈•.
          const idField = ingredientFieldSet.querySelector('input[type="hidden"][name$="[id]"]');
          if (!idField) {
            // Ak nem√° ID, je to nov√Ω, neulo≈æen√Ω riadok ‚Äì bezpeƒçne ho odstr√°nime √∫plne.
            ingredientFieldSet.remove();
          }

        } else {
          // Alternat√≠va, ak pole _destroy nem√°me (napr. pre nov√© polia v ≈°abl√≥ne)
          ingredientFieldSet.remove();
        }
      }
    });
  });
</script>