<%= form_with(model: recipe, class: "max-w-3xl mx-auto bg-white p-8 border border-orange-100 rounded-2xl space-y-6") do |form| %>

  <% if recipe.errors.any? %>
    <%# Chybov칠 hl치코ky laden칠 do jemnej oran쬺vo-캜ervenej %>
    <div class="bg-orange-50 border-l-4 border-orange-500 p-4 mb-6 rounded-r-lg">
      <h2 class="text-orange-900 font-bold"><%= pluralize(recipe.errors.count, "error") %> prohibited this recipe from being saved:</h2>
      <ul class="list-disc ml-5 text-orange-800 text-sm">
        <% recipe.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%# Z치kladn칠 칰daje %>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="md:col-span-3">
      <%= form.label :title, class: "block text-sm font-semibold text-orange-900 mb-1" %>
      <%= form.text_field :title, class: "appearance-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-orange-400 focus:border-orange-400 focus:z-10 sm:text-sm" %>
    </div>

    <div class="md:col-span-3">
      <%= form.label :instructions, class: "block text-sm font-semibold text-orange-900 mb-1" %>
      <%= form.text_area :instructions, rows: 5, class: "appearance-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-orange-400 focus:border-orange-400 focus:z-10 sm:text-sm" %>
    </div>

    <%# 캛asy v jednom riadku %>
    <div>
      <%= form.label :prep_time, "Prep Time (min)", class: "block text-sm font-semibold text-orange-900 mb-1" %>
      <%= form.number_field :prep_time, class: "appearance-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-orange-400 focus:border-orange-400 focus:z-10 sm:text-sm" %>
    </div>
    <div>
      <%= form.label :cook_time, "Cook Time (min)", class: "block text-sm font-semibold text-orange-900 mb-1" %>
      <%= form.number_field :cook_time, class: "appearance-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-orange-400 focus:border-orange-400 focus:z-10 sm:text-sm" %>
    </div>
    <div>
      <%= form.label :calories, "Calories (kcal)", class: "block text-sm font-semibold text-orange-900 mb-1" %>
      <%= form.text_field :calories, class: "appearance-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-orange-400 focus:border-orange-400 focus:z-10 sm:text-sm" %>
    </div>
  </div>

  <%# Ingrediencie %>
  <div class="pt-6 border-t border-orange-50">
    <h3 class="text-lg font-semibold text-orange-900 mb-4 flex items-center">
      <span class="mr-2 text-orange-400">游볫</span> Ingredients
    </h3>

    <%# "Header" tabu쬶y s ingredienciami %>
    <div class="grid grid-cols-12 gap-4 px-2 mb-2 border-b border-orange-100 pb-1">
      <div class="col-span-6 text-xs font-semibold text-orange-900 uppercase text-center">Ingredient</div>
      <div class="col-span-2 text-xs font-semibold text-orange-900 uppercase text-center">Amount</div>
      <div class="col-span-2 text-xs font-semibold text-orange-900 uppercase text-center">Unit</div>
      <div class="col-span-2"></div>
    </div>

    <div id="ingredients-fields" class="space-y-3">
      <% recipe.recipe_ingredients.each do |ri| %>
        <%= render 'recipe_ingredient_fields', recipe_ingredient: ri, all_ingredients: Ingredient.order(:name) %>
      <% end %>

      <% if recipe.new_record? && recipe.recipe_ingredients.empty? %>
        <%= render 'recipe_ingredient_fields', recipe_ingredient: recipe.recipe_ingredients.build, all_ingredients: Ingredient.order(:name) %>
      <% end %>
    </div>

    <button type="button" id="add-ingredient-button" 
        class="mt-4 flex items-center justify-center w-10 h-10 rounded-full border-0 text-sm font-semibold bg-orange-100 text-orange-700 hover:bg-orange-200 transition cursor-pointer focus:outline-none"
        title="Add ingredient">
      <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
      </svg>
    </button>
  </div>

  <%# S칰kromie a Kal칩rie %>
  <div class="grid grid-cols-1 <%= recipe.persisted? ? 'md:grid-cols-2' : 'md:grid-cols-1' %> gap-4 mt-6">
    <div class="flex items-center space-x-3 bg-orange-50 p-4 rounded-xl self-start border border-orange-100">
      <%= form.check_box :is_private, class: "h-5 w-5 text-orange-500 focus:ring-orange-400 border-orange-300 rounded" %>
      <%= form.label :is_private, "Private recipe (Only you will see this)", class: "text-sm font-medium text-orange-900" %>
    </div>
    <% if recipe.persisted? %>
      <div class="flex items-center space-x-3 bg-orange-50 p-4 rounded-xl self-start border border-orange-100">
        <%= form.check_box :recalculate_calories, class: "h-5 w-5 text-orange-500 focus:ring-orange-400 border-orange-300 rounded" %>
        <%= form.label :recalculate_calories, "Recalculate calories?", class: "text-sm font-medium text-orange-900" %>
      </div>
    <% end %>
  </div>

  <%# Tagy %>
  <div class="pt-6 border-t border-orange-50">
    <%# Nadpis na samostatnom riadku %>
    <h3 class="text-sm font-semibold text-orange-900 mb-2">Tags</h3>

    <%# Deliaca 캜iara cez cel칰 코칤rku %>
    <div class="w-full border-t border-orange-100 mb-6"></div>
    <div class="flex flex-wrap gap-4 justify-center">
      <%= form.collection_check_boxes :tag_ids, Tag.order(:name), :id, :name do |b| %>
        <label class="flex items-center space-x-2 cursor-pointer group">
          <%= b.check_box(
                checked: Array(params[:tag_ids]).include?(b.value.to_s),
                class: "w-5 h-5 text-orange-500 border-gray-300 rounded focus:ring-orange-400"
              ) %>
          <span class="text-gray-700 group-hover:text-orange-600 transition">
            <%= b.text %>
          </span>
        </label>
      <% end %>
    </div>
  </div>

  <%# Foto receptu %>
  <div class="pt-6 border-t border-orange-50">
    <%= form.label :image, "Recipe photo", class: "block text-orange-900 font-semibold mb-2" %>

    <% if @recipe.image.attached? && @recipe.image.persisted? %>
      <div class="flex items-center space-x-4 mb-4 bg-orange-50 p-3 rounded-xl border border-orange-100">
        <%= image_tag @recipe.image, class: "w-20 h-20 object-cover rounded-lg border-2 border-white" %>
        <div class="flex items-center">
          <%= form.check_box :remove_image, class: "w-4 h-4 text-red-500 border-orange-300 rounded focus:ring-red-400" %>
          <%= form.label :remove_image, "Remove current photo", class: "ml-2 text-sm text-red-600 font-semibold" %>
        </div>
      </div>
    <% end %>

    <%= form.file_field :image, 
      class: "block w-fit text-sm text-gray-500 
              file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 
              file:text-sm file:font-semibold file:bg-orange-100 file:text-orange-700 
              hover:file:bg-orange-200 
              file:transition file:duration-200 transition cursor-pointer" %>
  </div>

  <%# Submit tla캜idlo %>
  <div class="pt-6 border-t border-orange-100 flex justify-end">
    <%= form.submit class: "bg-gradient-to-r from-orange-400 to-orange-500 hover:from-orange-500 hover:to-orange-600 text-white font-bold py-3 px-10 rounded-xl transform active:scale-95 transition-all duration-200 cursor-pointer" %>
  </div>

<% end %>

<template id="ingredient-template">
  <%= render 'recipe_ingredient_fields', recipe_ingredient: RecipeIngredient.new, all_ingredients: Ingredient.order(:name) %>
</template>

<script>
  /**
   * 1. OCHRANN츼 POISTKA (Idempotencia)
   * Turbo v Rails 7 pri chyb치ch valid치cie (render :edit) znovu spust칤 tento <script>.
   * Bez tejto podmienky by sme pri ka쬯ej chybe pridali 캞al코칤 a 캞al코칤 'listener'.
   * window.ingredientsInitialized je glob치lna premenn치, ktor치 pre쬴je aj prekreslenie obsahu str치nky.
   */
  if (typeof window.ingredientsInitialized === 'undefined') {

    /**
     * 2. DEFIN칈CIA FUNKCIE PRE NOV칗 RIADOK
     * T칰to funkciu vol치me v쬯y, ke캞 Jakub klikne na tla캜idlo plus (+).
     */
    const addIngredientRow = () => {
      // N치jdeme miesto, kam sa maj칰 riadky vklada콘
      const container = document.getElementById('ingredients-fields');
      // N치jdeme skryt칰 HTML 코abl칩nu (template), v ktorej je pr치zdny riadok ingrediencie
      const template = document.getElementById('ingredient-template');

      // Ak by sme n치hodou neboli na str치nke s receptom, funkcia sa ukon캜칤 (prevencia errorov)
      if (!container || !template) return;

      // Naklonujeme obsah 코abl칩ny. 'true' znamen치, 쬰 chceme skop칤rova콘 v코etko vn칰tri (inputy, divy).
      const newFields = template.content.cloneNode(true);

      // Vlo쮂셠e tento nov칳 kus HTML na koniec n치코ho kontajnera
      container.appendChild(newFields);
    };

    /**
     * 3. DELEGOVANIE UDALOSTI NA 칔ROVNI DOKUMENTU
     * Namiesto toho, aby sme d치vali pozor priamo na tla캜idlo, d치vame pozor na cel칳 'document'.
     * Je to lep코ie, lebo dokument sa nemen칤, zatia 캜o formul치r sa pri chyb치ch st치le prepisuje.
     */
    document.addEventListener('click', (e) => {

      /**
       * A) LOGIKA PRE PRID츼VANIE (+)
       * e.target je element, na ktor칳 sa re치lne kliklo.
       * closest('#add-ingredient-button') zist칤, 캜i sme klikli na tla캜idlo alebo na nie캜o v 켿om (napr. ikonu).
       */
      if (e.target.closest('#add-ingredient-button')) {
        // Zabr치nime prehliada캜u, aby sk칰sil odosla콘 formul치r alebo obnovi콘 str치nku
        e.preventDefault();
        // Zavol치me na코u funkciu na pridanie riadku
        addIngredientRow();
      }

      /**
       * B) LOGIKA PRE ODSTR츼NENIE (Remove)
       * Tu kontrolujeme, 캜i kliknut칳 element m치 CSS triedu pre odstra켿ovanie.
       */
      if (e.target.classList.contains('remove-ingredient-button')) {
        // Op칛콘 zastav칤me predvolen칠 spr치vanie
        e.preventDefault();

        // N치jdeme cel칳 blok ingrediencie (fieldset), v ktorom sa nach치dza stla캜en칠 tla캜idlo
        const ingredientFieldSet = e.target.closest('.ingredient-field-set');

        if (ingredientFieldSet) {
          // Skontrolujeme, 캜i m치 tento riadok skryt칠 pole pre ID (znamen치 to, 쬰 u je v datab치ze)
          const idField = ingredientFieldSet.querySelector('input[type="hidden"][name$="[id]"]');

          if (!idField) {
            // Ak ID neexistuje, je to nov칳 riadok, ktor칳 Jakub pr치ve pridal.
            // Jednoducho ho odstr치nime z HTML a hotovo.
            ingredientFieldSet.remove();
          } else {
            // Ak ID existuje, mus칤me o zmazan칤 poveda콘 Railsu cez pole '_destroy'.
            const destroyField = ingredientFieldSet.querySelector('input[type="hidden"][name$="[_destroy]"]');
            if (destroyField) {
              // Nastav칤me hodnotu na 1. Ke캞 Jakub odo코le formul치r, Rails tento z치znam v DB zma쬰.
              destroyField.value = '1';
              // Riadok v HTML nesmieme 칰plne zmaza콘 (remove), lebo by sa neodoslalo to pole _destroy.
              // Preto ho len vizu치lne skryjeme.
              ingredientFieldSet.style.display = 'none';
            }
          }
        }
      }
    });

    /**
     * 4. Z츼MOK (Zabr치nenie duplicite)
     * Nastav칤me premenn칰 na true. Pri 캞al코om spusten칤 skriptu (po chybe valid치cie)
     * u podmienka 'if' na za캜iatku neprejde a neprid치 sa druh칳 listener.
     */
    window.ingredientsInitialized = true;
    console.log("Ingrediencie: Inicializ치cia 칰spe코n치.");
  }
</script>