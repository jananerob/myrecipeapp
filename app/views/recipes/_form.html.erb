<%= form_with(model: recipe, class: "max-w-3xl mx-auto bg-white p-8 border rounded-xl shadow-sm space-y-6") do |form| %>

  <% if recipe.errors.any? %>
    <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6">
      <h2 class="text-red-800 font-bold"><%= pluralize(recipe.errors.count, "error") %> prohibited this recipe from being saved:</h2>
      <ul class="list-disc ml-5 text-red-700 text-sm">
        <% recipe.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%# Z√°kladn√© √∫daje %>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="md:col-span-2">
      <%= form.label :title, class: "block text-sm font-semibold text-gray-700 mb-1" %>
      <%= form.text_field :title, class: "w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
    </div>

    <div class="md:col-span-2">
      <%= form.label :instructions, class: "block text-sm font-semibold text-gray-700 mb-1" %>
      <%= form.text_area :instructions, rows: 5, class: "w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
    </div>

    <%# ƒåasy v jednom riadku na desktopoch %>
    <div class="grid grid-cols-2 gap-4 md:col-span-2">
      <div>
        <%= form.label :prep_time, "Prep Time (min)", class: "block text-sm font-semibold text-gray-700 mb-1" %>
        <%= form.number_field :prep_time, class: "w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
      </div>
      <div>
        <%= form.label :cook_time, "Cook Time (min)", class: "block text-sm font-semibold text-gray-700 mb-1" %>
        <%= form.number_field :cook_time, class: "w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
      </div>
    </div>

    <div class="md:col-span-2">
      <%= form.label :calories, "Calories (kcal)", class: "block text-sm font-semibold text-gray-700 mb-1" %>
      <%= form.text_field :calories, class: "w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
    </div>
  </div>

  <%# Ingrediencie %>
  <div class="pt-6 border-t border-gray-100">
    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
      <span class="mr-2">üçé</span> Ingredients
    </h3>

    <div id="ingredients-fields" class="space-y-3">
      <% recipe.recipe_ingredients.each do |ri| %>
        <%= render 'recipe_ingredient_fields', recipe_ingredient: ri, all_ingredients: Ingredient.all %>
      <% end %>

      <% if recipe.new_record? && recipe.recipe_ingredients.empty? %>
        <%= render 'recipe_ingredient_fields', recipe_ingredient: recipe.recipe_ingredients.build, all_ingredients: Ingredient.all %>
      <% end %>
    </div>

    <button type="button" id="add-ingredient-button" class="mt-4 inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
      <svg class="-ml-1 mr-2 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M10 3a1a1 0 011 1v5h5a1a1 0 110 2h-5v5a1a1 0 11-2 0v-5H4a1a1 0 110-2h5V4a1a1 0 011-1z" clip-rule="evenodd" />
      </svg>
      Add ingredient
    </button>
  </div>

  <%# Tagy a S√∫kromie %>
  <div class="pt-6 border-t border-gray-100 grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
      <%= form.label :tag_ids, 'Tags', class: "block text-sm font-semibold text-gray-700 mb-1" %>
      <%= form.select :tag_ids, Tag.all.map { |t| [t.name, t.id] }, { include_blank: 'Select tags' }, { multiple: true, class: "w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 min-h-[100px]" } %>
    </div>

    <div class="flex items-center space-x-3 bg-gray-50 p-4 rounded-lg self-start">
      <%= form.check_box :is_private, class: "h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" %>
      <%= form.label :is_private, "Private recipe (Only you will see this)", class: "text-sm font-medium text-gray-700" %>
    </div>
  </div>

  <%# Submit tlaƒçidlo %>
  <div class="pt-6 border-t border-gray-200 flex justify-end">
    <%= form.submit class: "bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transform active:scale-95 transition-all duration-200 cursor-pointer" %>
  </div>
<% end %>

<template id="ingredient-template">
  <%= render 'recipe_ingredient_fields', recipe_ingredient: RecipeIngredient.new, all_ingredients: Ingredient.all %>
</template>

<!--  JavaScript pre prid√°vanie a odstra≈àovanie nov√Ωch z√°znamov ingredienci√≠
      prediskutova≈•, ƒçi nespravi≈• len cez fixn√Ω poƒçet mo≈æn√Ωch ingredienci√≠,
      alebo in√© rie≈°enie? Pri ka≈ædom kliknut√≠ na add_ingredient by sa ulo≈æil recept
      a pridal nov√Ω riadok pre nov√∫ ingredienciu, ale to sa mi v√¥bec nep√°ƒçi. -->

<script>
  document.addEventListener('turbo:load', () => {
    const container = document.getElementById('ingredients-fields');
    const addButton = document.getElementById('add-ingredient-button');
    const template = document.getElementById('ingredient-template');

    if (!addButton || !template) return; // Ukonƒç√≠, ak nie je na str√°nke s formul√°rom

    // Funkcia na pridanie riadku
    addButton.addEventListener('click', () => {
      // 1. Naklonuje obsah ≈°abl√≥ny
      const newFields = template.content.cloneNode(true);

      // 2. Vlo≈æ√≠ nov√© polia na koniec kontajnera
      container.appendChild(newFields);
    });

    // Funkcia na odstr√°nenie riadku (Delegovanie udalosti na kontajner)
    // Nov√©: Po kliknut√≠ na Remove oznaƒç√≠ riadok na zmazanie

    container.addEventListener('click', (e) => {
      if (e.target.classList.contains('remove-ingredient-button')) {

        // 1. N√°jdeme kontajner pre jeden riadok ingrediencie
        const ingredientFieldSet = e.target.closest('.ingredient-field-set');
        if (!ingredientFieldSet) return;

        // 2. N√°jdeme skryt√© pole pre zmazanie v r√°mci tohto riadku
        // TIP: pridaj si k tomuto poƒæu triedu, aby sa ƒæah≈°ie hƒæadalo (napr. class: 'destroy-field')
        const destroyField = ingredientFieldSet.querySelector('input[type="hidden"][name$="[_destroy]"]');

        // 3. Ak je to existuj√∫ci z√°znam, oznaƒç√≠me ho na zmazanie a skryjeme
        if (destroyField) {
          destroyField.value = '1'; // Nastav√≠ _destroy na 1
          ingredientFieldSet.style.display = 'none'; // Skryje vizu√°lne riadok

          // Bonus: Ak je to nov√Ω riadok, ktor√Ω e≈°te nebol ulo≈æen√Ω (nem√° ID), m√¥≈æeme ho odstr√°ni≈•.
          const idField = ingredientFieldSet.querySelector('input[type="hidden"][name$="[id]"]');
          if (!idField) {
            // Ak nem√° ID, je to nov√Ω, neulo≈æen√Ω riadok ‚Äì bezpeƒçne ho odstr√°nime √∫plne.
            ingredientFieldSet.remove();
          }

        } else {
          // Alternat√≠va, ak pole _destroy nem√°me (napr. pre nov√© polia v ≈°abl√≥ne)
          ingredientFieldSet.remove();
        }
      }
    });
  });
</script>